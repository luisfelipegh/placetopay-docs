openapi: 3.0.0
info:
  title: BETA - API de AutoPay - Solicitud de Balance
  version: 1.0.0
paths:
  /autopay/balance:
    post:
      summary: Obtener balance
      operationId: post-balance
      parameters:
        - schema:
            type: string
            example: application/json;charset=UTF-8
          in: header
          name: Content-Type
      responses:
        "200":
          description: Respuesta satisfactoria con el monto a cobrar al usuario
          content:
            application/json:
              schema:
                type: object
                required: [ status, id, amount ]
                properties:
                  status:
                    $ref: '#/components/schemas/Status'
                  id:
                    $ref: '#/components/schemas/AutoPayId'
                  amount:
                    $ref: "../base/es.yaml#/components/schemas/Amount"
                  min_amount:
                    $ref: "../base/es.yaml#/components/schemas/Amount"
        "4XX":
          description: Error en la solicitud.
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    $ref: '#/components/schemas/Status'
      description: 'Este endpoint devuelve un monto pendiente de cobro y el monto mínimo requerido para ejecutar el auto pago.'
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [ auth, reference, id ]
              properties:
                auth:
                  $ref: '../base/es.yaml#/components/schemas/Authentication'
                reference:
                  type: string
                  description: Referencia del AutoPago proporcionada por el cliente/comercio, esta referencia debe ser unica activa por comercio.
                  example: "ACC00012345"
                  maxLength: 32
                id:
                  $ref: '#/components/schemas/AutoPayId'
  /autopay/settlement:
    post:
      summary: Asentar un AutoPago
      operationId: post-settlement
      parameters:
        - schema:
            type: string
            example: application/json;charset=UTF-8
          in: header
          name: Content-Type
      responses:
        "200":
          description: Autopago registrado correctamente.
          content:
            application/json:
              schema:
                type: object
                required: [ status, id ]
                properties:
                  status:
                    $ref: '#/components/schemas/Status'
                  id:
                    $ref: '#/components/schemas/AutoPayId'
        "4XX":
          description: Error en la solicitud.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Status'
      description: 'Este endpoint registra y retorna únicamente el estado de la notificación (settlement).'
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [ reference, id, transaction ]
              properties:
                auth:
                  $ref: '../base/es.yaml#/components/schemas/Authentication'
                reference:
                  type: string
                  description: Referencia del AutoPago proporcionada por el cliente/comercio, esta referencia debe ser unica activa por comercio.
                  minLength: 32
                  maxLength: 32
                  example: "ACC00012345"
                id:
                  $ref: '#/components/schemas/AutoPayId'
                transaction:
                  $ref: "../base/es.yaml#/components/schemas/Transaction"
  /autopay/webhook:
    post:
      summary: Recepción de notificaciones AutoPay
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WebhookEvent'
      responses:
        "200":
          description: El webhook fue recibido correctamente.
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    $ref: '#/components/schemas/Status'
        "4XX":
          description: Ha ocurrido un error al recibir el Webhook.
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    $ref: "#/components/schemas/Status"
  /api/search:
    post:
      summary: Listar autopagos
      operationId: post-search
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - auth
              properties:
                auth:
                  $ref: '../base/es.yaml#/components/schemas/Authentication'
                filters:
                    type: object
                    description: Criterios de filtrado para la búsqueda.
                    properties:
                      reference:
                        type: string
                        description: Referencia del AutoPago proporcionada por el cliente/comercio, esta referencia debe ser unica activa por comercio.
                        example: "ACC00012345"
                        maxLength: 32
                      id:
                        $ref: '#/components/schemas/AutoPayId'
                      chargeTypes:
                        type: array
                        description: Filtrar por uno o varios tipos de cargo.
                        items:
                          $ref: '#/components/schemas/ChargeType'
                      status:
                        type: array
                        description: Estados del AutoPago a incluir.
                        items:
                            $ref: '#/components/schemas/StatusAutoPay'
                            example: [ "ACTIVE", "PENDING" ]
                      createdAt:
                          type: object
                          description: Rango de fechas de creación (ISO 8601, solo fecha).
                          properties:
                            from:
                              type: string
                              example: "2025-09-01"
                            to:
                              type: string
                              example: "2025-09-30"
                pagination:
                  $ref: '#/components/schemas/PaginationRequest'
      responses:
        "200":
          description: Solicitud exitosa
          content:
            application/json:
              schema:
                type: object
                required:
                  - status
                properties:
                  status:
                    $ref: '#/components/schemas/Status'
                  data:
                    description: Lista de autopagos que cumplen con los criterios de búsqueda.
                    type: array
                    items:
                      $ref: '#/components/schemas/AutoPay'
                  pagination:
                    $ref: '#/components/schemas/Pagination'
  /api/cancel:
    post:
      summary: Cancelar un autopago
      operationId: post-search
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - auth
                - id
              properties:
                auth:
                  $ref: '../base/es.yaml#/components/schemas/Authentication'
                id:
                  $ref: '#/components/schemas/AutoPayId'
      responses:
        "200":
          description: Solicitud exitosa
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    $ref: '#/components/schemas/Status'
                  id:
                    $ref: '#/components/schemas/AutoPayId'
        "4XX":
          description: Solicitud inválida
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    $ref: '#/components/schemas/Status'
  /api/create:
    post:
      summary: Crear un autopago
      operationId: post-search
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - auth
                - reference
                - chargeTypes
              properties:
                auth:
                  $ref: '../base/es.yaml#/components/schemas/Authentication'
                subscription:
                  type: object
                  required:
                    - reference
                    - description
                    - recurring
                  description: Estructura que contiene la información acerca de la suscripción asociada al AutoPago.
                  properties:
                    reference:
                      type: "string"
                      minLength: 1
                      maxLength: 32
                    description:
                      type: "string"
                      maxLength: 250
                    amount:
                      $ref: "../base/es.yaml#/components/schemas/Amount"
                      description: |
                        Estructura que define la información asociada al pago recurrente dentro del proceso de autopago. El valor y comportamiento de este campo dependen del tipo de cargo seleccionado por el usuario (chargeType) y de la configuración del comercio:
                        - Si el tipo de cargo es FIXED, el valor definido en este campo representará el monto que se cobrará de forma recurrente.
                        - Si el tipo de cargo es TOTAL_BALANCE o MINIMUM_BALANCE, este valor será ignorado, ya que el monto será determinado automáticamente con base en el estado de cuenta del usuario ([Balance](/autopay/contracts/balance)).
                        - Si el tipo de cargo es MINIMUM_PLUS_BALANCE, este valor será interpretado como un monto adicional al pago mínimo calculado a partir del [Balance](/autopay/contracts/balance)
                        En caso de no enviarse este campo y el tipo de cargo seleccionado lo requiera, el sistema solicitará al usuario completar la información correspondiente a través de la interfaz gráfica.
                      x-conditional:
                        - "currency"
                        - "total"
                    recurring:
                      $ref: "#/components/schemas/Recurring"
                chargeTypes:
                  type: array
                  description: Tipos de cargo permitidos dentro del autopago. Debe incluir al menos un tipo. En el caso de existir un solo tipo, este se tomará por defecto y se aplicará la lógica correspondiente al monto y configuración del comercio; si por el contrario existen varios tipos, en la redirección a la interfaz gráfica se le solicitará al usuario (pagador) escoger un tipo de cargo de los seleccionados por el cliente. Ver más en [Tipos de cargo](/autopay/charge-types).
                  minItems: 1
                  enum:
                    - TOTAL_BALANCE
                    - MINIMUM_BALANCE
                    - MINIMUM_PLUS_BALANCE
                    - FIXED
                  example:
                    - [ "TOTAL_BALANCE", "MINIMUM_BALANCE" ]
                locale:
                  type: "string"
                  description: "Idioma de la respuesta."
                  example: "es_ES"
                expiration:
                    type: string
                    format: date-time
                    description: Fecha de expiración de la sesión/solicitud.
                    example: "2025-12-15T00:00:00-05:00"
                returnUrl:
                    type: string
                    format: uri
                    maxLength: 255
                    description: URL de retorno post-proceso (longitud máxima actual 255).
                    example: "https://dnetix.co/p2p/client"
      responses:
        "200":
          description: Solicitud exitosa
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    $ref: '#/components/schemas/Status'
                  id:
                    $ref: '#/components/schemas/AutoPayId'
        "4XX":
          description: Solicitud inválida
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    $ref: '#/components/schemas/Status'
  /api/edit:
    post:
      summary: Actualizar un autopago
      operationId: post-edit
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - auth
                - id
              properties:
                auth:
                  $ref: '../base/es.yaml#/components/schemas/Authentication'
                id:
                  $ref: '#/components/schemas/AutoPayId'
      responses:
        "200":
          description: Solicitud exitosa
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    $ref: '#/components/schemas/Status'
                  id:
                    $ref: '#/components/schemas/AutoPayId'
                  processUrl:
                    type: string
                    format: uri
                    description: URL de redirección para completar el proceso de actualización.
                    example: "https://checkout-co.placetopay.com/session/1/cc9b8690b1f7228c78b759ce27d7e80a/edit"
        "400":
          description: Solicitud inválida
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    $ref: '#/components/schemas/Status'
        "401":
          description: Autenticación fallida
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    $ref: '#/components/schemas/Status'
  /api/query:
    post:
      summary: Consultar un autopago
      operationId: post-search
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - auth
                - id
              properties:
                auth:
                  $ref: '../base/es.yaml#/components/schemas/Authentication'
                id:
                  $ref: '#/components/schemas/AutoPayId'
      responses:
        "200":
          description: Solicitud exitosa
          content:
            application/json:
              schema:
                type: object
                required:
                  - status
                  - data
                properties:
                  status:
                    $ref: '#/components/schemas/Status'
                  data:
                    type: object
                    required:
                      - id
                      - status
                      - subscription
                      - createdAt
                    properties:
                      id:
                        $ref: '#/components/schemas/AutoPayId'
                      status:
                        $ref: '#/components/schemas/StatusAutoPay'
                      chargeType:
                        $ref: '#/components/schemas/ChargeType'
                      subscriptor:
                        $ref: '../base/es.yaml#/components/schemas/Person'
                      subscription:
                        type: object
                        required:
                          - reference
                          - description
                          - recurring
                        description: Estructura que contiene la información acerca de la suscripción asociada al AutoPago.
                        properties:
                          reference:
                            type: "string"
                            minLength: 1
                            maxLength: 32
                          description:
                            type: "string"
                            maxLength: 250
                          amount:
                            $ref: "../base/es.yaml#/components/schemas/Amount"
                            description: |
                              Solo presente cuando el tipo de cargo sea `FIXED` o `MINIMUM_PLUS_BALANCE`.
                              - `FIXED`: monto recurrente a cobrar.
                              - `MINIMUM_PLUS_BALANCE`: monto adicional al pago mínimo calculado.
                          recurring:
                            $ref: "#/components/schemas/Recurring"
                      acceptedAt:
                        type: string
                        format: date-time
                        description: Fecha en la que el usuario aceptó el AutoPago.
                        example: "2021-09-24T10:02:17-05:00"
                      createdAt:
                        type: string
                        format: date-time
                        description: Fecha de creación del AutoPago.
                        example: "2021-09-24T10:02:17-05:00"
                      expiration:
                        type: string
                        format: date-time
                        description: Fecha de expiración de la sesión/solicitud.
                        example: "2025-12-15T00:00:00-05:00"
                      returnUrl:
                        type: string
                        format: uri
                        maxLength: 255
                        description: URL de retorno post-proceso (longitud máxima actual 255).
                        example: "https://dnetix.co/p2p/client"
                      additional:
                        type: object
                        description: Información adicional de medio de pago y flujo.
                        properties:
                          franchise:
                            type: string
                            example: "visa"
                          lastDigits:
                            type: string
                            example: "0008"
                          bin:
                            type: string
                            example: "411111"
                          processUrl:
                            type: string
                            format: uri
                            example: "https://checkout-co.placetopay.com/session/1/cc9b8690b1f7228c78b759ce27d7e80a"
                      transactions:
                        type: array
                        description: Lista de las ultimas transacciones ejecutadas bajo este AutoPago.
                        items:
                          $ref: '../base/es.yaml#/components/schemas/Payment'
        "4XX":
          description: Solicitud inválida
          content:
            application/json:
              schema:
                required:
                  - status
                type: object
                properties:
                  status:
                    $ref: '#/components/schemas/Status'
components:
  schemas:
    AutoPay:
      type: object
      required:
        - id
        - status
        - subscription
        - createdAt
      properties:
        id:
          $ref: '#/components/schemas/AutoPayId'
        status:
          $ref: '#/components/schemas/StatusAutoPay'
        chargeType:
          $ref: '#/components/schemas/ChargeType'
        subscriptor:
          $ref: '../base/es.yaml#/components/schemas/Person'
        subscription:
          type: object
          required:
            - reference
            - description
            - recurring
          description: Estructura que contiene la información acerca de la suscripción asociada al AutoPago.
          properties:
            reference:
              type: "string"
              minLength: 1
              maxLength: 32
            description:
              type: "string"
              maxLength: 250
            amount:
              $ref: "../base/es.yaml#/components/schemas/Amount"
              description: |
                Solo presente cuando el tipo de cargo sea `FIXED` o `MINIMUM_PLUS_BALANCE`.
                - `FIXED`: monto recurrente a cobrar.
                - `MINIMUM_PLUS_BALANCE`: monto adicional al pago mínimo calculado.
            recurring:
              $ref: "#/components/schemas/Recurring"
        acceptedAt:
          type: string
          format: date-time
          description: Fecha en la que el usuario aceptó el AutoPago.
          example: "2021-09-24T10:02:17-05:00"
        createdAt:
          type: string
          format: date-time
          description: Fecha de creación del AutoPago.
          example: "2021-09-24T10:02:17-05:00"
        additional:
          type: object
          description: Información adicional de medio de pago y flujo.
          properties:
            franchise:
              type: string
              example: "visa"
            lastDigits:
              type: string
              example: "0008"
            bin:
              type: string
              example: "411111"
            processUrl:
              type: string
              format: uri
              example: "https://checkout-co.placetopay.com/session/1/cc9b8690b1f7228c78b759ce27d7e80a"
    ChargeType:
      type: string
      enum:
        - TOTAL_BALANCE
        - MINIMUM_BALANCE
        - MINIMUM_PLUS_BALANCE
        - FIXED
      description: Tipo de cargo del autopago. Ver más en [Tipos de cargo](/autopay/charge-types).
    AutoPayId:
      type: string
      format: uuid
      description: Identificador único del autopago confirmado en el registro de la notificación.
      minLength: 36
      maxLength: 36
      example: "2972c13d-6315-4da3-80d7-64c24eb232ad"
    Recurring:
      type: object
      description: Parámetros de recurrencia. En caso de no enviarse en la solicitud de creación, el sistema podrá solicitarlos al usuario en el momento de la redirección.
      properties:
        periodicity:
          type: string
          description: Periodicidad del cobro. D=Diario, W=Semanal, M=Mensual, Y=Anual.
          enum: [ D, W, M, Y ]
          example: M
        interval:
          type: string
          description: Cada cuántos períodos se realiza el cobro (ej. "1" = cada mes si periodicidad=M).
          pattern: '^[1-9][0-9]*$'
          example: "1"
        maxPeriods:
          type: integer
          description: Número máximo de períodos a cobrar.
          minimum: 1
          example: 12
        dueDay:
          type: integer
          description: Día de corte o vencimiento (1–28 para evitar meses cortos).
          minimum: 1
          maximum: 28
          example: 15
        paymentDate:
          type: string
          format: date-time
          description: Fecha a partir de la cual inicia el cobro.
          example: "2025-11-30T00:00:00-05:00"
    WebhookEvent:
      type: object
      required: [ auth, reference, id, type, date ]
      x-conditional: [ data ]
      properties:
        auth:
          $ref: '../base/es.yaml#/components/schemas/Authentication'
        reference:
          type: string
          description: Referencia del AutoPago proporcionada por el cliente/comercio, esta referencia debe ser unica activa por comercio.
          example: "ACC00012345"
          maxLength: 32
        id:
          type: string
          format: uuid
          description: Identificador único del AutoPago
          minLength: 36
          maxLength: 36
          example: "2972c13d-6315-4da3-80d7-64c24eb232ad"
        type:
          type: string
          enum:
            - AUTOPAY_UPDATED
            - AUTOPAY_FAILED
            - AUTOPAY_DELETED
          description: "Tipo de evento notificado. Ver más en [Eventos Webhook](/autopay/webhook-description#event-types)."
        date:
          type: string
          format: date-time
          description: Fecha y hora en la que se lanzó por primera vez el evento. En formato ISO 8601.
          example: "2025-09-29T17:09:29-05:00"
        data:
          type: object
          description: Objeto que contiene información relevante para identificar el autopago e información del evento.
          x-conditional:
            transactionId
            reason
          properties:
            transactionId:
              type: string
              format: uuid
              minLength: 36
              maxLength: 36
              description: Identificador del pago ejecutado. Puede venir cuando el evento es AUTOPAY_FAILED.
              example: "2972c13d-6315-4da3-80d7-64c24eb232ad"
            reason:
              type: string
              minLength: 2
              maxLength: 2
              description: Código de razón de actualización del autopago. Puede venir cuando el evento es AUTOPAY_FAILED, AUTOPAY_DELETED. Ver más en [Códigos de razón](/autopay/codes).
              example: "XA"
    Status:
      title: Status
      type: object
      description: Estructura para definir estados de respuestas
      x-internal: false
      properties:
        status:
          type: string
          enum:
            - OK
            - FAILED
            - APPROVED
          description: Estado de la petición.
        reason:
          type: string
          enum:
            - 100
            - 101
            - 102
            - 103
            - 104
            - '00'
            - BR
            - X3
            - XH
            - ?-
            - '05'
            - NF
          description: Razón del estado de la petición. (consulte en [Códigos de razón](/autopay/codes))
          example: '00'
        message:
          type: string
          description: Mensaje para aclarar el estado.
          example: "Respuesta satisfactoria"
        date:
          type: string
          format: date-time
          description: Fecha y hora en la que se generó la respuesta.
          example: "2025-09-29T17:09:29-05:00"
      required:
        - status
        - reason
        - message
    StatusAutoPay:
        $ref: '#/components/schemas/Status'
        enum: [ ACTIVE, CANCELED, PENDING ]
        example: ACTIVE
    Pagination:
      title: Pagination
      type: object
      description: Estructura que contiene la información de la paginación.
      required:
        - total
        - perPage
        - currentPage
        - lastPage
      properties:
        total:
          type: integer
          example: 30
          minimum: 1
          description: Número total de registros encontrados en la consulta.
        perPage:
          type: integer
          default: 15
          example: 10
          minimum: 1
          description: Número de registros por página
        currentPage:
          type: integer
          default: 1
          minimum: 1
          example: 1
          description: Página actual
        lastPage:
          type: integer
          minimum: 1
          example: 1
          description: Ultima página disponible
    PaginationRequest:
      title: Pagination
      type: object
      description: Estructura que contiene la información de la paginación.
      properties:
        perPage:
          type: integer
          default: 15
          example: 10
          minimum: 1
          description: Número de registros por página
        currentPage:
          type: integer
          default: 1
          minimum: 1
          example: 1
          description: Página actual